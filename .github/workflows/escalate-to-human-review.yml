name: Escalate ADF Pipeline to Human Review

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  check-retry-limit:
    runs-on: ubuntu-latest
    # Only trigger on PR comments (not issues)
    if: github.event.issue.pull_request
    
    steps:
      - name: Get current retry count
        id: get-retry
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            const pr = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: pr_number
            });
            
            // Find retry count label
            const retryLabel = pr.data.labels.find(l => l.name.startsWith('retry-count-'))?.name;
            const retryCount = retryLabel ? parseInt(retryLabel.match(/\d+/)[0]) : 0;
            
            console.log(`Current retry count: ${retryCount}`);
            core.setOutput('result', retryCount.toString());

      - name: Check for max retries and escalate
        if: fromJson(steps.get-retry.outputs.result) >= 3
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Get the linked issue number
            const pr = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: pr_number
            });
            
            const issueMatch = pr.data.body?.match(/Resolves #(\d+)/) || 
                              pr.data.head.ref.match(/adf-pipeline\/(\d+)-/);
            const issueNumber = issueMatch?.[1];
            
            // Post escalation comment
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr_number,
              body: `## ⚠️ Maximum Review Cycles Reached\n\n` +
                    `The pipeline has gone through 3 generation-review cycles and continues to have issues.\n\n` +
                    `**Status**: This PR and related issue require **human intervention**.\n\n` +
                    `**Next steps:**\n` +
                    `- [ ] A maintainer or subject matter expert should review this PR\n` +
                    `- [ ] Determine if the requirements are achievable or need revision\n` +
                    `- [ ] Manually fix the pipeline or update the issue requirements\n` +
                    (issueNumber ? `- [ ] Close issue #${issueNumber} when resolved\n` : '') +
                    `\n` +
                    `**Context**: Agents attempted to generate and fix this pipeline automatically, ` +
                    `but continued issues suggest the problem may require human judgment or clarification.`
            });
            
            // Add escalation labels
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: pr_number,
              labels: ['needs-human-review', 'escalated']
            });
            
            // Remove generation/review labels
            try {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: pr_number,
                name: 'generation-in-progress'
              });
            } catch (e) {
              console.log('generation-in-progress label not found');
            }
            
            try {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: pr_number,
                name: 'review-in-progress'
              });
            } catch (e) {
              console.log('review-in-progress label not found');
            }
            
            // If linked to an issue, add a comment there too
            if (issueNumber) {
              try {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  body: `❌ **Agent Pipeline Generation Escalated**\n\n` +
                        `The ADF pipeline generation has reached the maximum retry limit (3 cycles) ` +
                        `and requires human review.\n\n` +
                        `**See PR**: #${pr_number}\n\n` +
                        `A maintainer will investigate and either:\n` +
                        `- Fix the pipeline manually\n` +
                        `- Update the requirements for clarity\n` +
                        `- Close the issue if it's not feasible`
                });
              } catch (e) {
                console.log(`Could not comment on issue #${issueNumber}`);
              }
            }

      - name: Request review from maintainers
        if: fromJson(steps.get-retry.outputs.result) >= 3
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Get repo maintainers/admins for assignment
            // This is a suggestion - you would need to configure team names
            console.log('Note: Configure CODEOWNERS or add specific reviewer teams for automatic assignment');
            console.log('Example: Add this PR to a board or mention a specific team');
