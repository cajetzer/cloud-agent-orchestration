name: Assign ADF Generate Agent to Issue

on:
  issues:
    types: [labeled, opened]

permissions:
  issues: write
  contents: read

jobs:
  assign-generate-agent:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'adf-generate')
    steps:
      - name: Check if Copilot already assigned
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const assignees = issue.assignees.map(a => a.login);
            
            if (assignees.includes('copilot-swe-agent[bot]')) {
              console.log('âœ… Copilot already assigned');
              core.setOutput('should_assign', 'false');
            } else {
              console.log('ðŸ“‹ Copilot not yet assigned');
              core.setOutput('should_assign', 'true');
            }
      
      - name: Assign Copilot Agent
        if: steps.check.outputs.should_assign == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            console.log(`ðŸ¤– Assigning Copilot to issue #${issue_number} for ADF pipeline generation`);
            
            // Post initial comment with instructions
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: `## ðŸ¤– Copilot Agent Assignment

I've assigned Copilot to generate the ADF pipeline based on your requirements.

**What I'll do:**
1. âœ… Read and analyze all pipeline requirements
2. âœ… Generate a complete ADF pipeline JSON
3. âœ… Create a PR with the pipeline configuration
4. âœ… Ensure all requirements are met

**Please wait** - pipeline generation in progress...`
            });
            
            // Add tracking labels
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number,
              labels: ['agent-in-progress']
            });
