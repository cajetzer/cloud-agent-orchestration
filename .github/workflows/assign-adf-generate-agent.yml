name: Assign ADF Generate Agent to Issue

on:
  issues:
    types: [labeled, opened]

permissions:
  issues: write

jobs:
  assign-agent:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'adf-generate')
    steps:
      - name: Check if already assigned
        id: check-assigned
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const assignees = issue.assignees.map(a => a.login);
            
            // Check if Copilot is already assigned (username may vary)
            if (assignees.some(a => a.includes('copilot'))) {
              console.log('Copilot already assigned');
              core.setOutput('already_assigned', 'true');
              return;
            }
            core.setOutput('already_assigned', 'false');
      
      - name: Post assignment comment
        if: steps.check-assigned.outputs.already_assigned == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ¤– **ADF Pipeline Generation Agent Assigned**\n\n' +
                    'The ADF Generation Agent will:\n' +
                    '1. Read your pipeline requirements\n' +
                    '2. Generate the ADF pipeline JSON\n' +
                    '3. Create a pull request with the implementation\n' +
                    '4. Automatically request review from the ADF Review Agent\n\n' +
                    '_Assigning Copilot with custom agent..._'
            });
            
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['agent-in-progress']
            });
      
      - name: Assign Copilot with ADF Generate Agent via GraphQL
        if: steps.check-assigned.outputs.already_assigned == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NODE_ID: ${{ github.event.issue.node_id }}
        run: |
          # Get Copilot bot user ID first
          COPILOT_ID=$(gh api graphql -f query='
          query {
            user(login: "copilot") {
              id
            }
          }' --jq '.data.user.id' 2>/dev/null || echo "")
          
          if [ -z "$COPILOT_ID" ]; then
            echo "Warning: Could not retrieve Copilot bot ID. Skipping GraphQL assignment."
            echo "You may need to manually open this issue in Copilot Workspace and select the adf-generate agent."
            exit 0
          fi
          
          echo "Copilot ID: $COPILOT_ID"
          
          # Assign Copilot with custom agent
          gh api graphql \
            -H 'GraphQL-Features: issues_copilot_assignment_api_support,coding_agent_model_selection' \
            -f query='
            mutation($issueId: ID!, $actorIds: [ID!]!) {
              addAssigneesToAssignable(input: {
                assignableId: $issueId,
                assigneeIds: $actorIds
              }) {
                assignable {
                  ... on Issue {
                    id
                    title
                    number
                  }
                }
              }
            }' \
            -f issueId="$ISSUE_NODE_ID" \
            -f actorIds="[$COPILOT_ID]" || {
              echo "GraphQL assignment failed. Manual workspace trigger required."
              exit 0
            }
