name: Assign ADF Review Agent to PR

on:
  pull_request:
    types: [opened, labeled, synchronize]

permissions:
  pull-requests: write
  issues: write
  contents: write

jobs:
  assign-review:
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'adf-pipeline')
    steps:
      - name: Check if review already in progress
        id: check-review
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = context.issue.number;
            const comments = await github.rest.issues.listComments({
              issue_number: pr_number,
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const reviewed = comments.data.some(c => 
              c.body.includes('ðŸ” ADF Pipeline Review Agent Assigned')
            );
            
            if (reviewed) {
              console.log('Review already assigned');
              core.setOutput('already_reviewed', 'true');
              return;
            }
            
            core.setOutput('already_reviewed', 'false');
      
      - name: Get or initialize retry count
        if: steps.check-review.outputs.already_reviewed == 'false'
        id: retry-count
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const retryLabel = pr.labels.find(l => l.name.startsWith('retry-count-'))?.name;
            const retryCount = retryLabel ? parseInt(retryLabel.match(/\d+/)[0]) : 1;
            
            console.log(`Current retry count: ${retryCount}`);
            core.setOutput('count', retryCount.toString());
      
      - name: Post review assignment comment
        if: steps.check-review.outputs.already_reviewed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = context.issue.number;
            const retryCount = '${{ steps.retry-count.outputs.count }}';
            
            await github.rest.issues.createComment({
              issue_number: pr_number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ” **ADF Pipeline Review Agent Assigned**\n\n' +
                    'The ADF Review Agent will check this pipeline for:\n' +
                    '- Structural correctness\n' +
                    '- Activity configuration\n' +
                    '- Error handling policies\n' +
                    '- Security best practices\n' +
                    '- Naming conventions\n\n' +
                    `_Review cycle: ${retryCount} of 3_\n\n` +
                    '_Assigning Copilot with review agent..._'
            });
            
            // Only add retry-count-1 if no retry label exists
            const labels = ['review-in-progress'];
            if (retryCount === 1) {
              labels.push('retry-count-1');
            }
            
            await github.rest.issues.addLabels({
              issue_number: pr_number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: labels
            });
      
      - name: Assign Copilot with ADF Review Agent via GraphQL
        if: steps.check-review.outputs.already_reviewed == 'false'
        env:
          # Use COPILOT_PAT if available (required for Copilot assignment), otherwise fall back to GITHUB_TOKEN
          GH_TOKEN: ${{ secrets.COPILOT_PAT || secrets.GITHUB_TOKEN }}
          PR_NODE_ID: ${{ github.event.pull_request.node_id }}
          REPO_NODE_ID: ${{ github.event.repository.node_id }}
        run: |
          # Get Copilot bot node ID using REST API (GraphQL user query doesn't work for bots)
          COPILOT_ID=$(gh api /users/copilot-swe-agent[bot] --jq '.node_id' 2>/dev/null || echo "")
          
          if [ -z "$COPILOT_ID" ]; then
            echo "Warning: Could not retrieve Copilot bot ID. Skipping GraphQL assignment."
            echo "You may need to manually open this PR in Copilot Workspace and select the adf-review agent."
            exit 0
          fi
          
          echo "Copilot ID: $COPILOT_ID"
          
          # Assign Copilot as reviewer with custom agent using agentAssignment
          gh api graphql \
            -H 'GraphQL-Features: issues_copilot_assignment_api_support,coding_agent_model_selection' \
            -f query="
            mutation {
              addAssigneesToAssignable(input: {
                assignableId: \"$PR_NODE_ID\",
                assigneeIds: [\"$COPILOT_ID\"],
                agentAssignment: {
                  targetRepositoryId: \"$REPO_NODE_ID\",
                  baseRef: \"main\",
                  customAgent: \"adf-review\",
                  customInstructions: \"Review the ADF pipeline JSON for correctness, best practices, and security. Post findings as a comment.\"
                }
              }) {
                assignable {
                  ... on PullRequest {
                    id
                    title
                    number
                  }
                }
              }
            }" || {
              echo "GraphQL assignment failed. Manual workspace trigger required."
              exit 0
            }
