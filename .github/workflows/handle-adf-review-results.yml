name: Handle ADF Review Results & Agent Handoff

on:
  issue_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  process-review-outcome:
    runs-on: ubuntu-latest
    # Trigger on review agent comments with findings
    if: |
      (github.event.issue.pull_request && 
       contains(github.event.comment.body, 'ADF Pipeline Review Results')) ||
      (github.event.review && 
       github.event.review.state == 'COMMENTED')
    
    steps:
      - name: Parse review results
        id: review-findings
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Get the most recent review comment
            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: pr_number
            });
            
            const reviewComment = comments.data.find(c => 
              c.body.includes('ADF Pipeline Review Results')
            );
            
            if (!reviewComment) {
              console.log('No review results found');
              return null;
            }
            
            // Parse for error/warning indicators
            const hasErrors = reviewComment.body.includes('ERRORS:') && 
                             reviewComment.body.includes('âŒ');
            const hasWarningsOnly = reviewComment.body.includes('WARNINGS:') && 
                                   !hasErrors;
            const noIssues = reviewComment.body.includes('No issues found');
            
            console.log(`Errors: ${hasErrors}, Warnings only: ${hasWarningsOnly}, No issues: ${noIssues}`);
            
            core.setOutput('has_errors', hasErrors.toString());
            core.setOutput('warnings_only', hasWarningsOnly.toString());
            core.setOutput('no_issues', noIssues.toString());

      - name: Handoff to Generation Agent (Errors Found)
        if: steps.review-findings.outputs.has_errors == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Get current retry count and PR details
            const pr = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: pr_number
            });
            
            const retryLabel = pr.data.labels.find(l => l.name.startsWith('retry-count-'))?.name;
            const currentCount = retryLabel ? parseInt(retryLabel.match(/\d+/)[0]) : 1;
            const nextCount = currentCount + 1;
            
            // Comment to trigger generation agent fix
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr_number,
              body: `## ðŸ”§ Issues Found - Routing Back to Generation Agent\n\n` +
                    `The pipeline review identified errors. The **ADF Generation Agent** has been re-assigned to fix them.\n\n` +
                    `**Generation Agent: Please address the errors listed in the review above:**\n\n` +
                    `1. Read the error descriptions carefully\n` +
                    `2. Update the pipeline JSON file\n` +
                    `3. Push the fixes to this branch\n` +
                    `4. The review agent will automatically re-review your changes\n\n` +
                    `**Retry cycle**: ${nextCount} of 3`
            });
            
            // Update retry counter
            if (retryLabel) {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: pr_number,
                name: retryLabel
              });
            }
            
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: pr_number,
              labels: [`retry-count-${nextCount}`, 'changes-requested', 'generation-in-progress']
            });
            
            // Remove review-in-progress
            try {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: pr_number,
                name: 'review-in-progress'
              });
            } catch (e) {
              console.log('Label not found, continuing');
            }
      
      - name: Re-assign Generation Agent via GraphQL API
        if: steps.review-findings.outputs.has_errors == 'true'
        env:
          # Use COPILOT_PAT if available (required for Copilot assignment), otherwise fall back to GITHUB_TOKEN
          GH_TOKEN: ${{ secrets.COPILOT_PAT || secrets.GITHUB_TOKEN }}
          PR_NODE_ID: ${{ github.event.issue.node_id }}
          REPO_NODE_ID: ${{ github.event.repository.node_id }}
        run: |
          # Get Copilot bot node ID using REST API (GraphQL user query doesn't work for bots)
          COPILOT_ID=$(gh api /users/copilot-swe-agent[bot] --jq '.node_id' 2>/dev/null || echo "")
          
          if [ -z "$COPILOT_ID" ]; then
            echo "Warning: Could not retrieve Copilot bot ID."
            echo "The generation agent will need to be manually re-assigned in Copilot Workspace."
            echo ""
            echo "To continue the fix cycle:"
            echo "1. Open this PR in Copilot Workspace (click 'Open in Workspace' button)"
            echo "2. Select the 'adf-generate' agent from the dropdown"
            echo "3. The agent will read the review feedback and fix the issues"
            exit 0
          fi
          
          echo "Re-assigning Copilot to fix pipeline errors..."
          
          # Re-assign Copilot with adf-generate agent to fix errors
          gh api graphql \
            -H 'GraphQL-Features: issues_copilot_assignment_api_support,coding_agent_model_selection' \
            -f query="
            mutation {
              addAssigneesToAssignable(input: {
                assignableId: \"$PR_NODE_ID\",
                assigneeIds: [\"$COPILOT_ID\"],
                agentAssignment: {
                  targetRepositoryId: \"$REPO_NODE_ID\",
                  baseRef: \"main\",
                  customAgent: \"adf-generate\",
                  customInstructions: \"Fix the ADF pipeline errors identified in the review comment. Update the pipeline JSON to address all errors, then push to this branch.\"
                }
              }) {
                assignable {
                  ... on PullRequest {
                    id
                    title
                    number
                  }
                }
              }
            }" || {
              echo "GraphQL re-assignment failed. Manual trigger required for fix cycle."
              exit 0
            }

      - name: Approve PR (Warnings Only)
        if: steps.review-findings.outputs.warnings_only == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr_number,
              body: `## âœ… Approved with Minor Suggestions\n\n` +
                    `The pipeline has been approved by the review agent. ` +
                    `The warnings above are recommendations â€” this pipeline is functional and follows best practices.\n\n` +
                    `A human reviewer may want to address these suggestions before merging.`
            });
            
            await github.rest.issues.removeLabel({
              owner,
              repo,
              issue_number: pr_number,
              name: 'review-in-progress'
            });
            
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: pr_number,
              labels: ['approved-with-warnings']
            });

      - name: Approve PR (No Issues)
        if: steps.review-findings.outputs.no_issues == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr_number,
              body: `## âœ… Pipeline Approved\n\n` +
                    `The pipeline looks great! It follows ADF best practices and is ready for merge.\n\n` +
                    `**Next steps:**\n- [ ] Human review (if required)\n- [ ] Merge to production\n- [ ] Close related issue`
            });
            
            await github.rest.issues.removeLabel({
              owner,
              repo,
              issue_number: pr_number,
              name: 'review-in-progress'
            });
            
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: pr_number,
              labels: ['approved']
            });
